<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vielen Dank! â€” CE365 Agent</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <nav class="nav">
        <div class="container nav-inner">
            <a href="/" class="logo">CE365 <span class="logo-agent">Agent</span></a>
            <div class="nav-links">
                <a href="/" class="btn btn-nav">Zur Startseite</a>
            </div>
        </div>
    </nav>

    <section class="thankyou">
        <div class="container">
            <div id="loading">
                <div class="spinner"></div>
                <h2 style="margin-top: 24px;">Deine Lizenz wird erstellt...</h2>
                <p class="hero-description">Bitte warte einen Moment.</p>
            </div>
            <div id="success" style="display: none;">
                <h1 class="hero-title">Willkommen bei Pro!</h1>
                <p class="hero-description">Deine Lizenz wurde erfolgreich erstellt. Kopiere den Schl&uuml;ssel und f&uuml;ge ihn im Setup-Wizard ein.</p>
                <div class="license-box">
                    <div style="font-size: 0.88rem; color: var(--text-secondary); margin-bottom: 8px;">Dein Lizenzschl&uuml;ssel</div>
                    <div class="license-key" id="license-key">&mdash;</div>
                    <button onclick="copyKey()" class="btn btn-primary" id="copy-btn" style="margin-top: 8px;">Kopieren</button>
                </div>
                <div style="max-width: 520px; margin: 40px auto;">
                    <h3 style="margin-bottom: 16px; text-align: center;">Pro Binary herunterladen</h3>
                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;" id="download-buttons">
                        <a class="btn btn-primary" style="min-width: 180px; text-align: center;" id="dl-win" onclick="downloadBinary('win-amd64')">Windows (.exe)</a>
                        <a class="btn btn-primary" style="min-width: 180px; text-align: center;" id="dl-mac-arm" onclick="downloadBinary('macos-arm64')">macOS (Apple Silicon)</a>
                        <a class="btn btn-secondary" style="min-width: 180px; text-align: center;" id="dl-mac-intel" onclick="downloadBinary('macos-amd64')">macOS (Intel)</a>
                    </div>
                    <p style="text-align: center; margin-top: 16px; color: var(--text-tertiary); font-size: 0.82rem;">
                        Oder per pip: <code>pip install ce365-agent</code> &rarr; <code>python -m ce365 --setup</code> &rarr; Pro w&auml;hlen &amp; Key einf&uuml;gen
                    </p>
                </div>
                <p style="color: var(--text-tertiary); font-size: 0.82rem; margin-top: 32px;">
                    Best&auml;tigung wurde an <strong id="customer-email" style="color: var(--text-secondary);"></strong> gesendet.<br>
                    Fragen? <a href="mailto:info@eckhardt-marketing.de">info@eckhardt-marketing.de</a>
                </p>
            </div>
            <div id="error" style="display: none;">
                <h2 class="section-title">Etwas ist schiefgelaufen</h2>
                <p class="hero-description">Die Zahlung wurde verarbeitet, aber die Lizenz konnte noch nicht abgerufen werden. Bitte lade die Seite neu.</p>
                <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">Seite neu laden</button>
                <p style="color: var(--text-tertiary); font-size: 0.82rem; margin-top: 16px;">Falls das Problem bestehen bleibt: <a href="mailto:info@eckhardt-marketing.de">info@eckhardt-marketing.de</a></p>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2026 Carsten Eckhardt / Eckhardt-Marketing. Alle Rechte vorbehalten.</p>
            </div>
        </div>
    </footer>

    <script>
        const API_URL = "https://license.ce365.de";
        function downloadBinary(platform) {
            var key = document.getElementById("license-key").textContent;
            if (!key || key === "\u2014") { alert("Lizenzschluessel wird noch geladen..."); return; }
            window.location.href = API_URL + "/api/update/download/" + platform + "?license_key=" + encodeURIComponent(key);
        }
        function copyKey() {
            navigator.clipboard.writeText(document.getElementById("license-key").textContent).then(function() {
                var btn = document.getElementById("copy-btn");
                btn.textContent = "Kopiert!";
                setTimeout(function() { btn.textContent = "Kopieren"; }, 2000);
            });
        }
        (function() {
            var params = new URLSearchParams(window.location.search);
            var sessionId = params.get("session_id");
            if (!sessionId) { document.getElementById("loading").style.display = "none"; document.getElementById("error").style.display = "block"; return; }
            var attempts = 0;
            function tryFetch() {
                attempts++;
                fetch(API_URL + "/api/stripe/checkout-status?session_id=" + sessionId)
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.status === "complete" && data.license_key) {
                            document.getElementById("loading").style.display = "none";
                            document.getElementById("success").style.display = "block";
                            document.getElementById("license-key").textContent = data.license_key;
                            document.getElementById("customer-email").textContent = data.customer_email;
                        } else if (attempts < 10) { setTimeout(tryFetch, 2000); }
                        else { document.getElementById("loading").style.display = "none"; document.getElementById("error").style.display = "block"; }
                    })
                    .catch(function() {
                        if (attempts < 10) setTimeout(tryFetch, 2000);
                        else { document.getElementById("loading").style.display = "none"; document.getElementById("error").style.display = "block"; }
                    });
            }
            setTimeout(tryFetch, 1500);
        })();
    </script>
</body>
</html>
